<div>{{Header}}</div>
<div style="display:none;">{{cloze:Occlusions}}</div>
<canvas id="canvas" style="background-size: 100% 100%; max-width: 100%; max-height: 90vh;">
</canvas>
<div style="display:none;">{{Image}}</div>
<div>{{Notes}}</div>

<script>
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    
    var img = new Image();
    img.onload = function () {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        drawShapes(ctx);
    };
    img.src = document.getElementById("img").src;

    function drawShapes(ctx) {
        var ioCloze = document.getElementById("io_cloze");
        for (cloze of ioCloze.children) {
            var shape = cloze.dataset.type;
            var qColor = cloze.dataset.fill;
            var aColor = ioCloze.dataset.answerMaskColor;

            if (cloze.children.length) {
                if (cloze.children[0].className.includes("cloze-inactive")) {
                    draw(shape, qColor);
                }
            }
        }
    }

    function draw(shape, color) {
        ctx.fillStyle = color;

        switch (shape) {
            case "rect":
                ctx.fillRect(cloze.dataset.left, cloze.dataset.top, cloze.dataset.width, cloze.dataset.height);
                break;

            case "ellipse":
                ctx.beginPath();
                ctx.ellipse(cloze.dataset.left, cloze.dataset.top, cloze.dataset.rx, cloze.dataset.ry, 0, 0, Math.PI * 2, false);
                ctx.fill();
                break;

            case "circle":
                ctx.beginPath();
                ctx.arc(cloze.dataset.left, cloze.dataset.top, cloze.dataset.radius, 0, 2 * Math.PI);
                ctx.fill();
                break;

            case "triangle":
                var top = parseFloat(cloze.dataset.top);
                var left = parseFloat(cloze.dataset.left);
                var width = parseFloat(cloze.dataset.width);
                var height = parseFloat(cloze.dataset.height);

                ctx.beginPath();
                ctx.moveTo(left, top + height);
                ctx.lineTo(left + width, top + height);
                ctx.lineTo(left + (width / 2), top);
                ctx.closePath();
                ctx.fill();
                break;

            case "polygon":
                var polygonPoints = JSON.parse(cloze.dataset.points);
                var points = [];

                polygonPoints.forEach((point) => {
                    points.push([point.x, point.y]);
                });

                ctx.beginPath();
                ctx.moveTo(points[0][0], points[0][1]);
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i][0], points[i][1]);
                }
                ctx.closePath();
                ctx.fill();
                break;
        }
    }
</script>